<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>DomeChat</title>
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>
  <script> if(!localStorage.getItem('domechatTermsAccepted')) location.href='terms.html'; </script>

  <main class="center">
    <h1 class="logo">DOMECHAT</h1>
    <div id="trendingTitle" style="opacity:.9">Trending topics right now</div>
    <div id="trendingWrap"></div>

    <video id="preview" autoplay muted playsinline></video>
    <div id="permNote" style="opacity:.85;font-size:12px;"></div>

    <div>Enter a topic or pick one above:</div>
    <input id="topic" type="text" placeholder="Enter your topic" maxlength="60"/>
    <div><button id="startBtn">Connect to Video Chat</button></div>
  </main>

<script>
  // Camera inline preview (no box)
  let previewStream = null;
  async function startPreview(){
    try {
      previewStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}, audio:false});
      const v = document.getElementById('preview');
      v.srcObject = previewStream;
      v.style.display = 'block';
      document.getElementById('permNote').textContent = 'Preview active âœ“';
    } catch {
      document.getElementById('permNote').textContent = 'Click "Connect" and allow camera when prompted.';
    }
  }
  window.addEventListener('pageshow', ()=>{ startPreview(); });
  window.addEventListener('pagehide', ()=>{ try{previewStream?.getTracks().forEach(t=>t.stop());}catch{} });

  // Trending fetch (ensure TikTok ðŸ”¥)
  async function loadTrending(){
    try {
      const res = await fetch('/trending', {cache:'no-store'});
      let data = await res.json();
      if (!data.some(x=> x.topic.toLowerCase()==='tiktok')) data.unshift({topic:'TikTok', count:0});
      const wrap = document.getElementById('trendingWrap');
      wrap.innerHTML = '';
      data.slice(0,12).forEach(item => {
        const t = item.topic;
        const chip = document.createElement('button');
        chip.className = 'chip';
        chip.innerHTML = (t.toLowerCase()==='tiktok' ? '<span class="hot">ðŸ”¥</span>' : '') + t + (item.count>0 ? ` (${item.count})` : '');
        chip.onclick = () => location.href = '/chat.html?topic=' + encodeURIComponent(t);
        wrap.appendChild(chip);
      });
    } catch(e){ console.warn('trending failed', e); }
  }
  loadTrending(); setInterval(loadTrending, 10000);

  const go=()=>{
    const t=document.getElementById('topic').value.trim();
    location.href='/chat.html'+(t?('?topic='+encodeURIComponent(t)):'')
  };
  document.getElementById('startBtn').onclick=go;
  document.getElementById('topic').addEventListener('keypress',e=>{ if(e.key==='Enter') go(); });
</script>
</body>
</html>
