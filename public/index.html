<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>DomeChat</title>
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>
  <script> if(!localStorage.getItem('domechatTermsAccepted')) location.href='terms.html'; </script>

  <main class="center">
    <h1 class="logo">DOMECHAT</h1>
    <div id="trendingTitle" style="opacity:.9">Trending topics right now</div>
    <div id="trendingWrap"></div>

    <div style="margin-top:14px">Or enter your own:</div>
    <input id="topic" type="text" placeholder="Enter your topic" maxlength="60"/>
    <div><button id="startBtn">Connect to Video Chat</button></div>

    <div id="permNote" style="opacity:.85;font-size:12px;"></div>
  </main>

<script>
  // Pre-permission prompt
  (async function prePermission(){
    try {
      const stream = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
      stream.getTracks().forEach(t=>t.stop());
      localStorage.setItem('domechatMediaGranted','1');
      document.getElementById('permNote').textContent = 'Camera & mic access granted âœ“';
    } catch {
      document.getElementById('permNote').textContent = 'Please allow camera & mic when prompted on the chat screen.';
    }
  })();

  // Trending fetch
  async function loadTrending(){
    try {
      const res = await fetch('/trending', {cache:'no-store'});
      const data = await res.json();
      const wrap = document.getElementById('trendingWrap');
      wrap.innerHTML = '';
      data.forEach(item => {
        const t = item.topic;
        const chip = document.createElement('button');
        chip.className = 'chip';
        chip.textContent = t + (item.count>0 ? ` (${item.count})` : '');
        chip.onclick = () => location.href = '/chat.html?topic=' + encodeURIComponent(t);
        wrap.appendChild(chip);
      });
    } catch(e){
      console.warn('trending fetch failed', e);
    }
  }
  loadTrending();
  setInterval(loadTrending, 10000);

  const go=()=>{
    const t=document.getElementById('topic').value.trim();
    location.href='/chat.html'+(t?('?topic='+encodeURIComponent(t)):'')
  };
  document.getElementById('startBtn').onclick=go;
  document.getElementById('topic').addEventListener('keypress',e=>{ if(e.key==='Enter') go(); });
</script>
</body>
</html>
