
<!DOCTYPE html><html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dome Phone</title><link rel="stylesheet" href="styles.css"/>
<style>#roomCode{font-weight:700;letter-spacing:2px}</style></head><body>
<div class="page">
  <h1 class="logo" style="text-align:center;margin:10px 0 14px">DOME PHONE</h1>
  <div class="surface" style="padding:16px">
    <div class="dp-row" style="display:flex;gap:12px;flex-wrap:wrap;align-items:center">
      <input id="nickname" placeholder="Nickname" maxlength="16" style="padding:10px;border-radius:10px;border:1px solid var(--line);background:#09152d;color:#fff"/>
      <button id="createBtn">Create Room</button>
      <input id="joinCode" placeholder="Enter room code" maxlength="6" style="text-transform:uppercase;padding:10px;border-radius:10px;border:1px solid var(--line);background:#09152d;color:#fff"/>
      <button id="joinBtn" class="ghost">Join</button>
    </div>
    <div style="margin-top:6px;opacity:.85">Recommended: <b>6â€“12 players</b>. You can toggle camera in the lobby.</div>
  </div>

  <div id="stageLobby" class="surface" style="display:none;margin-top:12px;padding:12px">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
      <div>Room: <span id="roomCode"></span></div>
      <div><button id="toggleCamBtn" class="ghost">Camera: Off</button>
           <button id="leaveBtn" class="ghost" onclick="location.href='/'">Leave</button></div>
    </div>
    <div id="players" style="margin-top:8px"></div>
    <div id="videoGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:8px;margin-top:12px"></div>
    <div style="margin-top:12px;opacity:.8" id="capNote">Up to 4 cameras can be on at once (for performance).</div>
  </div>
</div>
<script src="/socket.io/socket.io.js"></script>
<script>
let ICE={iceServers:[{urls:['stun:stun.l.google.com:19302']}]};(async()=>{try{const r=await fetch('/ice',{cache:'no-store'});const l=await r.json();if(Array.isArray(l)&&l.length)ICE={iceServers:l}}catch{}})();
const codeChars='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';const makeCode=(n=6)=>Array.from({length:n},()=>codeChars[Math.floor(Math.random()*codeChars.length)]).join('');
const getNickLS=()=> (localStorage.getItem('dome_nick')||'').trim();const setNickLS=n=>localStorage.setItem('dome_nick',n);
const socket=io('/domephone',{path:'/socket.io'});
const stageLobby=document.getElementById('stageLobby');const roomSpan=document.getElementById('roomCode');
const playersDiv=document.getElementById('players');const videoGrid=document.getElementById('videoGrid');const toggleCamBtn=document.getElementById('toggleCamBtn');
let roomCode=null,nickname=null;
function needNick(){nickname=document.getElementById('nickname').value.trim()||getNickLS();if(!nickname){const n=(prompt('Choose a nickname (3â€“16 chars):')||'').trim().slice(0,16);if(!n||n.length<3){alert('Nickname required.');return true}nickname=n;setNickLS(nickname);document.getElementById('nickname').value=nickname}else setNickLS(nickname);return false}
document.getElementById('createBtn').onclick=()=>{if(needNick())return;roomCode=makeCode(6);joinRoom(roomCode,nickname,true)};
document.getElementById('joinBtn').onclick=()=>{if(needNick())return;roomCode=(document.getElementById('joinCode').value||'').toUpperCase().slice(0,6);if(!roomCode)return alert('Enter room code');joinRoom(roomCode,nickname,false)};
document.getElementById('nickname').value=getNickLS();
function joinRoom(code,nick,created){socket.emit('joinLobby',code,nick,created)}
socket.on('joined',({code,players,created,nick})=>{nickname=nick||nickname;setNickLS(nickname);roomCode=code;roomSpan.textContent=code;stageLobby.style.display='block';renderPlayers(players)});
socket.on('players',players=>renderPlayers(players));
function renderPlayers(players){playersDiv.textContent='Players: '+players.map(p=>p.nick+(p.camOn?' ðŸŽ¥':'' )).join(', ');
for(const p of players){let holder=document.getElementById('tile_'+p.id);if(!holder){holder=document.createElement('div');holder.id='tile_'+p.id;holder.style.position='relative';holder.style.display='inline-block';holder.style.width='160px';holder.style.margin='4px';videoGrid.appendChild(holder);
const v=document.createElement('video');v.id='v_'+p.id;v.autoplay=true;v.playsInline=true;holder.appendChild(v);const label=document.createElement('div');label.className='nameLabel';label.textContent=p.nick;holder.appendChild(label)}else{const label=holder.querySelector('.nameLabel');if(label)label.textContent=p.nick}}}
const peers=new Map();let localStream=null;const ICECONF=()=>ICE;let camOn=false;
toggleCamBtn.onclick=async()=>{if(!camOn){try{localStream=await navigator.mediaDevices.getUserMedia({video:true,audio:false})}catch(e){return alert('Allow camera to turn it on.')}camOn=true;toggleCamBtn.textContent='Camera: On';addSelfVideo(localStream);socket.emit('camState',{on:true});startPeerConns()}else{camOn=false;toggleCamBtn.textContent='Camera: Off';stopSelfStream();socket.emit('camState',{on:false});for(const {pc} of peers.values()){pc.getSenders().forEach(s=>{if(s.track&&s.track.kind==='video')pc.removeTrack(s)})}}};
function addSelfVideo(stream){let holder=document.getElementById('tile_self');if(!holder){holder=document.createElement('div');holder.id='tile_self';holder.style.position='relative';holder.style.display='inline-block';holder.style.width='160px';holder.style.margin='4px';videoGrid.prepend(holder);
const v=document.createElement('video');v.id='selfVideo';v.autoplay=true;v.muted=true;v.playsInline=true;holder.appendChild(v);const label=document.createElement('div');label.className='nameLabel';label.textContent=nickname||'You';holder.appendChild(label);peers.set('self',{isSelf:true,pc:null,videoEl:v})}holder.querySelector('video').srcObject=stream}
function stopSelfStream(){const self=peers.get('self');if(self&&self.videoEl){self.videoEl.srcObject=null;self.videoEl.parentElement.remove()}peers.delete('self');localStream?.getTracks().forEach(t=>t.stop());localStream=null}
function ensurePeer(peerId){if(peers.has(peerId))return peers.get(peerId);const pc=new RTCPeerConnection(ICECONF());if(localStream)localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
pc.ontrack=e=>{const v=document.getElementById('v_'+peerId);if(v){v.srcObject=e.streams[0];v.play().catch(()=>{})}};pc.onicecandidate=({candidate})=>{if(candidate)socket.emit('dp-signal',{to:peerId,type:'ice',candidate})};peers.set(peerId,{pc,videoEl:document.getElementById('v_'+peerId)});return peers.get(peerId)}
function startPeerConns(){socket.emit('dp-peers')}
socket.on('dp-peers',async(ids)=>{for(const id of ids){if(id===socket.id)continue;const {pc}=ensurePeer(id);const offer=await pc.createOffer();await pc.setLocalDescription(offer);socket.emit('dp-signal',{to:id,type:'sdp',description:pc.localDescription})}});
socket.on('dp-signal',async({from,type,description,candidate})=>{const {pc}=ensurePeer(from);if(type==='sdp'){await pc.setRemoteDescription(description);if(description.type==='offer'){const ans=await pc.createAnswer();await pc.setLocalDescription(ans);socket.emit('dp-signal',{to:from,type:'sdp',description:pc.localDescription})}}else if(type==='ice'){try{await pc.addIceCandidate(candidate)}catch{}}});
socket.on('leftPeer',(id)=>{const p=peers.get(id);if(p&&p.videoEl){p.videoEl.srcObject=null}const tile=document.getElementById('tile_'+id);tile&&tile.remove();peers.delete(id)});
</script></body></html>
