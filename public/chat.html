
<!DOCTYPE html><html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>DomeChat Chat</title><link rel="stylesheet" href="styles.css"/></head><body>
<div id="topbar">
  <div class="brand"><div class="dot"></div><div class="logo">DOMECHAT</div></div>
  <div class="controls">
    <button id="muteBtn" class="ghost square" title="Toggle microphone">Mic: On</button>
    <button id="camBtn" class="ghost square" title="Toggle camera">Cam: On</button>
    <button id="streamBtn" class="ghost square" title="Streamer mode">Streamer: Off</button>
    <button id="nextBtn" class="square">Find Next</button>
    <button id="reportBtn" class="ghost square" title="Report (nudity)">Report</button>
    <button id="blockBtn" class="ghost square" title="Block">Block</button>
    <button id="disconnectBtn" class="ghost square">Exit</button>
  </div>
</div>
<div class="page"><div class="grid">
  <div class="surface" id="videoStage">
    <div id="searchOverlay" class="searching" style="display:none">
      <div style="text-align:center"><div class="dotpulse" style="margin:0 auto 8px"></div><div style="opacity:.9">Searching for a partnerâ€¦</div></div>
    </div>
    <div id="camOverlay" style="position:absolute;left:0;right:0;top:0;bottom:0;display:none;z-index:6;
         background:linear-gradient(180deg,rgba(11,27,59,.7),rgba(11,27,59,.4));backdrop-filter:blur(6px);
         display:flex;align-items:center;justify-content:center;">
      <div style="max-width:560px;background:linear-gradient(180deg,#0f1f3f,#0b1835);
                  border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:16px;text-align:center;color:#eef3ff">
        <b>Enable your camera & microphone</b>
        <p style="margin:8px 0 12px;color:#9fb0d0">Click below and allow permissions in your browser.</p>
        <button id="enableCamBtn">Enable camera & mic</button>
      </div>
    </div>
    <video id="remoteVideo" autoplay playsinline></video>
    <video id="localVideo" autoplay muted playsinline></video>
    <div class="reaction-bar" id="reactionBar">
      <button class="reaction-btn" data-r="ğŸ˜‚">ğŸ˜‚</button>
      <button class="reaction-btn" data-r="ğŸ‘">ğŸ‘</button>
      <button class="reaction-btn" data-r="â¤ï¸">â¤ï¸</button>
      <button class="reaction-btn" data-r="ğŸ˜®">ğŸ˜®</button>
      <button class="reaction-btn" data-r="ğŸ‘">ğŸ‘</button>
      <button class="reaction-btn" data-r="ğŸš©">ğŸš©</button>
    </div>
  </div>
  <div id="chatPanel">
    <div id="chatMessages" aria-live="polite"></div>
    <div id="typingIndicator"></div>
    <div id="controlsRow">
      <input id="messageInput" placeholder="Type your messageâ€¦" autocomplete="off"/>
      <button id="sendBtn" disabled>Send</button>
    </div>
  </div>
</div></div>
<div class="follow-badge">follow domechat.live on TikTok</div>
<script src="/socket.io/socket.io.js"></script>
<script>
const chat=document.getElementById('chatMessages');
function logUI(msg){const d=document.createElement('div');d.className='system';d.textContent=msg;chat.appendChild(d);chat.scrollTop=9e9}
function addMessage(text,self=false){const d=document.createElement('div');d.className='msg '+(self?'self':'other');d.textContent=text;const t=document.createElement('span');t.className='timestamp';t.textContent=new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});d.appendChild(t);chat.appendChild(d);chat.scrollTop=chat.scrollHeight}
const searchOverlay=document.getElementById('searchOverlay');function setSearching(on){searchOverlay.style.display=on?'flex':'none'}
const toB64=b=>btoa(String.fromCharCode(...new Uint8Array(b)));const fromB64=b=>{const s=atob(b),u=new Uint8Array(s.length);for(let i=0;i<s.length;i++)u[i]=s.charCodeAt(i);return u.buffer}
let cryptoKey=null,keyPair=null;async function genECDH(){keyPair=await crypto.subtle.generateKey({name:'ECDH',namedCurve:'P-256'},true,['deriveKey']);const raw=await crypto.subtle.exportKey('raw',keyPair.publicKey);return toB64(raw)}async function importPeer(pub){const raw=fromB64(pub);const peer=await crypto.subtle.importKey('raw',raw,{name:'ECDH',namedCurve:'P-256'},true,[]);cryptoKey=await crypto.subtle.deriveKey({name:'ECDH',public:peer},keyPair.privateKey,{name:'AES-GCM',length:256},false,['encrypt','decrypt'])}
async function encryptText(t){const iv=crypto.getRandomValues(new Uint8Array(12));const c=await crypto.subtle.encrypt({name:'AES-GCM',iv},cryptoKey,new TextEncoder().encode(t));return{iv:toB64(iv.buffer),data:toB64(c)}}async function decryptText(p){const pt=await crypto.subtle.decrypt({name:'AES-GCM',iv:fromB64(p.iv).slice(0)},cryptoKey,fromB64(p.data));return new TextDecoder().decode(pt)}
const SID_KEY='dome_sid';let sessionId=localStorage.getItem(SID_KEY);if(!sessionId){sessionId=(crypto.randomUUID?.()||(Date.now().toString(36)+Math.random().toString(36).slice(2,8)));localStorage.setItem(SID_KEY,sessionId)}
let ICE={iceServers:[{urls:['stun:stun.l.google.com:19302']}]};
const params=new URLSearchParams(location.search);const topic=(params.get('topic')||'').trim();const forceRelay=params.get('relay')==='1';
(async()=>{try{const r=await fetch('/ice',{cache:'no-store'});const list=await r.json();if(Array.isArray(list)&&list.length)ICE={iceServers:list}}catch{}})();
const camOverlay=document.getElementById('camOverlay');const enableCamBtn=document.getElementById('enableCamBtn');const localVideo=document.getElementById('localVideo');const remoteVideo=document.getElementById('remoteVideo');const muteBtn=document.getElementById('muteBtn');const camBtn=document.getElementById('camBtn');
function isiOS(){return /iPad|iPhone|iPod/.test(navigator.userAgent)||(navigator.platform==='MacIntel'&&navigator.maxTouchPoints>1)}async function tryPlay(el){if(!el)return;try{await el.play()}catch{camOverlay.style.display='block'}}
let localStream=null,micMuted=false,camOff=false;async function ensureLocal(force=false){if(localStream&&!force)return localStream;localStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'user',width:{ideal:1280},height:{ideal:720}},audio:true});localVideo.srcObject=localStream;await tryPlay(localVideo);camOverlay.style.display='none';logUI('âœ… Camera ready');return localStream}
enableCamBtn?.addEventListener('click',()=>ensureLocal(true));ensureLocal().catch(()=>{});
muteBtn?.addEventListener('click',()=>{micMuted=!micMuted;localStream?.getAudioTracks().forEach(t=>t.enabled=!micMuted);muteBtn.textContent='Mic: '+(micMuted?'Off':'On')});
camBtn?.addEventListener('click',()=>{camOff=!camOff;localStream?.getVideoTracks().forEach(t=>t.enabled=!camOff);camBtn.textContent='Cam: '+(camOff?'Off':'On')});
function preferBestCodec(pc){try{const caps=RTCRtpSender.getCapabilities('video');if(!caps)return;const h264=caps.codecs.filter(c=>/video\/H264/i.test(c.mimeType));const vp8=caps.codecs.filter(c=>/video\/VP8/i.test(c.mimeType));const choice=isiOS()?(h264.length?h264:vp8):(vp8.length?vp8:h264);const tr=pc.getTransceivers().find(t=>t.sender?.track?.kind==='video');if(tr&&choice?.length)tr.setCodecPreferences(choice)}catch{}}
let pc,makingOffer=false,ignoreOffer=false,isPolite=false,hasPartner=false,currentPartnerId=null;const pendingCandidates=[];let remoteTrackTimer=null;
async function createPC(){pc=new RTCPeerConnection({...ICE,...(forceRelay?{iceTransportPolicy:'relay'}:{})});pc.onicecandidate=({candidate})=>{if(candidate&&hasPartner)socket.emit('signal',{type:'ice',candidate})};pc.onicecandidateerror=e=>logUI('ICE candidate error: '+(e?.errorText||e?.errorCode||'unknown'));pc.onicegatheringstatechange=()=>logUI('ICE gathering: '+pc.iceGatheringState);pc.onsignalingstatechange=()=>logUI('Signaling: '+pc.signalingState);pc.onconnectionstatechange=()=>{logUI('PC: '+pc.connectionState);if(pc.connectionState==='failed'){try{pc.restartIce();logUI('Trying ICE restartâ€¦')}catch{}}};pc.ontrack=e=>{if(e.streams&&e.streams[0]){remoteVideo.srcObject=e.streams[0];remoteVideo.muted=false;tryPlay(remoteVideo)}};
const ls=await ensureLocal();ls.getTracks().forEach(t=>pc.addTrack(t,ls));preferBestCodec(pc);
pc.onnegotiationneeded=async()=>{try{makingOffer=true;const hasVideo=pc.getSenders().some(s=>s.track&&s.track.kind==='video');if(!hasVideo)ls.getTracks().forEach(t=>pc.addTrack(t,ls));await pc.setLocalDescription(await pc.createOffer());socket.emit('signal',{type:'sdp',description:pc.localDescription})}finally{makingOffer=false}}}
function startRemoteWaitTimer(){clearTimeout(remoteTrackTimer);remoteTrackTimer=setTimeout(()=>{logUI('No remote track yet â€” ICE restart');try{pc?.restartIce()}catch{};setTimeout(()=>{if(!remoteVideo.srcObject)socket.emit('next')},5000)},10000)}
const socket=io();socket.emit('session',sessionId);socket.emit('setTopic',topic);
socket.on('roles',({polite,peerId})=>{isPolite=!!polite;currentPartnerId=peerId;if(getBlocked().has(peerId))setTimeout(()=>socket.emit('next'),0)});
socket.on('waiting',msg=>{addMessage(msg);setSearching(true)});
socket.on('partnerFound',async()=>{setSearching(false);hasPartner=true;chat.textContent='';addMessage('You found a new partner!');if(!pc)await createPC();const pub=await genECDH();socket.emit('ecdh-public',pub);startRemoteWaitTimer()});
socket.on('partnerDisconnected',()=>{hasPartner=false;addMessage('Partner disconnected. Searchingâ€¦');setSearching(true);setTimeout(()=>{if(!hasPartner)socket.emit('next')},2500)});
socket.on('forceDisconnect',()=>{hasPartner=false;addMessage('Partner disconnected. Searchingâ€¦');setSearching(true);setTimeout(()=>{if(!hasPartner)socket.emit('next')},2500)});
socket.on('signal',async({type,description,candidate})=>{if(!pc)await createPC();try{if(type==='sdp'){const collision=(description.type==='offer')&&(makingOffer||pc.signalingState!=='stable');ignoreOffer=!isPolite&&collision;if(ignoreOffer)return;await pc.setRemoteDescription(description);while(pendingCandidates.length){try{await pc.addIceCandidate(pendingCandidates.shift())}catch{}}if(description.type==='offer'){await ensureLocal();await pc.setLocalDescription(await pc.createAnswer());socket.emit('signal',{type:'sdp',description:pc.localDescription})}}else if(type==='ice'){if(!pc.remoteDescription)pendingCandidates.push(candidate);else{try{await pc.addIceCandidate(candidate)}catch(e){console.warn('addIceCandidate failed',e)}}}}catch(e){console.warn('signal error',e)}});
const BLOCK_KEY='dome_blocked_ids';const getBlocked=()=>new Set(JSON.parse(localStorage.getItem(BLOCK_KEY)||'[]'));const setBlocked=s=>localStorage.setItem(BLOCK_KEY,JSON.stringify([...s]));
const typing=document.getElementById('typingIndicator');socket.on('partnerTyping',({from})=>{if(!hasPartner||from!==currentPartnerId)return;typing.textContent='Partner is typing...';setTimeout(()=>typing.textContent='',1200)});
const sendBtn=document.getElementById('sendBtn');const msgIn=document.getElementById('messageInput');sendBtn.disabled=true;msgIn.disabled=true;
socket.on('ecdh-public',async(peer)=>{try{await importPeer(peer);sendBtn.disabled=false;msgIn.disabled=false}catch{}});
sendBtn.onclick=async()=>{const txt=msgIn.value.trim();if(!txt||!hasPartner||!cryptoKey)return;const payload=await encryptText(txt);socket.emit('enc-message',{payload,from:socket.id});addMessage(txt,true);msgIn.value=''};
msgIn.addEventListener('keypress',e=>{if(e.key==='Enter')sendBtn.click();else if(hasPartner)socket.emit('typing',{from:socket.id})});
socket.on('enc-message',({payload,from})=>{if(from===socket.id)return;decryptText(payload).then(text=>addMessage(text,false)).catch(()=>{})});
function spawnReaction(emoji){const host=document.getElementById('videoStage');const el=document.createElement('div');el.className='reaction-fx';el.textContent=emoji;const x=(host.clientWidth/2)+(Math.random()*160-80);const y=host.clientHeight-40;el.style.left=x+'px';el.style.top=y+'px';host.appendChild(el);setTimeout(()=>el.remove(),1400)}
let lastReact=0;document.getElementById('reactionBar').addEventListener('click',e=>{const now=Date.now();if(now-lastReact<600)return;lastReact=now;const btn=e.target.closest('[data-r]');if(!btn||!hasPartner)return;const emoji=btn.getAttribute('data-r');spawnReaction(emoji);socket.emit('reaction',{emoji})});
socket.on('reaction',({emoji})=>spawnReaction(emoji));
document.getElementById('blockBtn').onclick=()=>{if(!currentPartnerId)return alert('No partner to block.');const s=getBlocked();s.add(currentPartnerId);setBlocked(s);alert('Blocked. You wonâ€™t be matched again.');socket.emit('disconnectPartner')};
document.getElementById('reportBtn').onclick=()=>{if(!currentPartnerId)return alert('No partner to report.');socket.emit('report',{partnerId:currentPartnerId,topic});const s=getBlocked();s.add(currentPartnerId);setBlocked(s);alert('Reported. You wonâ€™t be matched again.');socket.emit('disconnectPartner')};
const streamBtn=document.getElementById('streamBtn');let streamerOn=false,wm;streamBtn.onclick=()=>{streamerOn=!streamerOn;document.body.classList.toggle('streamer',streamerOn);streamBtn.textContent='Streamer: '+(streamerOn?'On':'Off');if(streamerOn&&!wm){wm=document.createElement('div');wm.className='streamer-watermark';wm.textContent='STREAMER MODE â€” chat hidden';document.body.appendChild(wm)}else if(!streamerOn&&wm){wm.remove();wm=null}};
document.getElementById('nextBtn').onclick=()=>{if(hasPartner)socket.emit('next');else socket.emit('setTopic',topic)};
document.getElementById('disconnectBtn').onclick=()=>{if(hasPartner)socket.emit('disconnectPartner');hasPartner=false;location.href='/'};
</script></body></html>
