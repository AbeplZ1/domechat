
<!DOCTYPE html><html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>DomeChat Chat</title><link rel="stylesheet" href="styles.css"/></head><body>
<div id="topbar"><div class="brand"><div class="dot"></div><div class="logo">DOMECHAT</div></div></div>
<div class="page">
  <div class="controls" style="margin-bottom:10px">
    <button id="muteBtn" class="ghost square" title="Toggle microphone">Mic: On</button>
    <button id="camBtn" class="ghost square" title="Toggle camera">Cam: On</button>
    <button id="streamBtn" class="ghost square" title="Streamer mode">Streamer: Off</button>
    <button id="nextBtn" class="square">Find Next</button>
    <button id="reportBtn" class="ghost square" title="Report (nudity)">Report</button>
    <button id="blockBtn" class="ghost square" title="Block">Block</button>
    <button id="disconnectBtn" class="ghost square">Exit</button>
  </div>
  <div class="grid">
    <div class="surface" id="videoStage">
      <div id="searchOverlay" class="searching" style="display:none"><div style="text-align:center">
        <div class="dotpulse" style="margin:0 auto 8px"></div><div>Searching for a partner…</div></div></div>
      <div id="camOverlay" class="center" style="display:flex">
        <div class="cam-card">
          <b>Enable your camera & microphone</b>
          <p style="margin:8px 0 12px;color:#aab3c0">Click below and allow permissions in your browser.</p>
          <button id="enableCamBtn">Enable camera & mic</button>
          <div style="margin-top:8px;font-size:12px;color:#aab3c0">If no prompt appears, click the lock icon in the address bar and allow Camera & Microphone.</div>
          <div id="diag" style="margin-top:10px;font-size:12px;color:#aab3c0;white-space:pre-wrap"></div>
        </div>
      </div>
      <div id="unmuteOverlay">Tap to unmute</div>
      <video id="remoteVideo" autoplay playsinline></video>
      <video id="localVideo" autoplay muted playsinline></video>
      <div class="reaction-bar" id="reactionBar">
        <button class="reaction-btn" data-r="😂">😂</button><button class="reaction-btn" data-r="👍">👍</button>
        <button class="reaction-btn" data-r="❤️">❤️</button><button class="reaction-btn" data-r="😮">😮</button>
        <button class="reaction-btn" data-r="👎">👎</button><button class="reaction-btn" data-r="🚩">🚩</button>
      </div>
    </div>
    <div id="chatPanel" class="surface" style="padding:12px">
      <div id="chatMessages" aria-live="polite"></div>
      <div id="typingIndicator"></div>
      <div id="controlsRow"><input id="messageInput" placeholder="Type your message…" autocomplete="off"/><button id="sendBtn" disabled>Send</button></div>
    </div>
  </div>
</div>
<div class="follow-badge">follow domechat.live on TikTok</div>
<script src="/socket.io/socket.io.js"></script>
<script>
const chat=document.getElementById('chatMessages');const typing=document.getElementById('typingIndicator');
function addMessage(text,self=false){const d=document.createElement('div');d.className='msg '+(self?'self':'other');d.textContent=text;const t=document.createElement('span');t.className='timestamp';t.textContent=new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});d.appendChild(t);chat.appendChild(d);chat.scrollTop=chat.scrollHeight}
const setSearching=(on)=>document.getElementById('searchOverlay').style.display=on?'flex':'none';
const diag=document.getElementById('diag');

/* E2EE optional */
const toB64=b=>btoa(String.fromCharCode(...new Uint8Array(b)));const fromB64=b=>{const s=atob(b),u=new Uint8Array(s.length);for(let i=0;i<s.length;i++)u[i]=s.charCodeAt(i);return u.buffer}
let cryptoKey=null,keyPair=null;async function genECDH(){keyPair=await crypto.subtle.generateKey({name:'ECDH',namedCurve:'P-256'},true,['deriveKey']);const raw=await crypto.subtle.exportKey('raw',keyPair.publicKey);return toB64(raw)}async function importPeer(pub){const raw=fromB64(pub);const peer=await crypto.subtle.importKey('raw',raw,{name:'ECDH',namedCurve:'P-256'},true,[]);cryptoKey=await crypto.subtle.deriveKey({name:'ECDH',public:peer},keyPair.privateKey,{name:'AES-GCM',length:256},false,['encrypt','decrypt'])}
async function encryptText(t){const iv=crypto.getRandomValues(new Uint8Array(12));const c=await crypto.subtle.encrypt({name:'AES-GCM',iv},cryptoKey,new TextEncoder().encode(t));return{iv:toB64(iv.buffer),data:toB64(c)}}async function decryptText(p){const pt=await crypto.subtle.decrypt({name:'AES-GCM',iv:fromB64(p.iv).slice(0)},cryptoKey,fromB64(p.data));return new TextDecoder().decode(pt)}

/* Session & ICE */
const SID_KEY='dome_sid';let sessionId=localStorage.getItem(SID_KEY);if(!sessionId){sessionId=(crypto.randomUUID?.()||(Date.now().toString(36)+Math.random().toString(36).slice(2,8)));localStorage.setItem(SID_KEY,sessionId)}
let ICE={iceServers:[{urls:['stun:stun.l.google.com:19302']}]};
(async()=>{try{const r=await fetch('/ice',{cache:'no-store'});const list=await r.json();if(Array.isArray(list)&&list.length)ICE={iceServers:list}}catch{}})();
const params=new URLSearchParams(location.search);const topic=(params.get('topic')||'').trim();const forceRelay=params.get('relay')==='1';

/* Camera */
const camOverlay=document.getElementById('camOverlay');const enableCamBtn=document.getElementById('enableCamBtn');
const localVideo=document.getElementById('localVideo');const remoteVideo=document.getElementById('remoteVideo');const unmuteOverlay=document.getElementById('unmuteOverlay');
remoteVideo.muted=true; // allow autoplay in all browsers
unmuteOverlay.style.display='block';unmuteOverlay.onclick=()=>{remoteVideo.muted=false;unmuteOverlay.style.display='none'};
async function ensureLocal(){
  try{
    const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'user',width:{ideal:1280},height:{ideal:720}},audio:true});
    localVideo.srcObject=stream; localVideo.muted=true; await localVideo.play().catch(()=>{});
    camOverlay.style.display='none'; diag.textContent=''; return stream;
  }catch(e){ camOverlay.style.display='flex'; diag.textContent='getUserMedia error: '+(e.name||'')+' '+(e.message||''); return null; }
}
let localStream=null; camOverlay.style.display='flex';
enableCamBtn.addEventListener('click', async()=>{ localStream = await ensureLocal(); });

/* Codec */
function preferBestCodec(pc){
  try{const caps=RTCRtpSender.getCapabilities('video');if(!caps)return;const h264=caps.codecs.filter(c=>/video\/H264/i.test(c.mimeType));const vp8=caps.codecs.filter(c=>/video\/VP8/i.test(c.mimeType));const isiOS=/iPad|iPhone|iPod/.test(navigator.userAgent)||(navigator.platform==='MacIntel'&&navigator.maxTouchPoints>1);const choice=isiOS?(h264.length?h264:vp8):(vp8.length?vp8:h264);const tr=pc.getTransceivers().find(t=>t.sender?.track?.kind==='video');if(tr&&choice?.length)tr.setCodecPreferences(choice)}catch{}
}

/* WebRTC */
let pc,makingOffer=false,ignoreOffer=false,isPolite=false,hasPartner=false,currentPartnerId=null;const pendingCandidates=[];
function drainPending(){if(!pc||!pc.remoteDescription)return;while(pendingCandidates.length){const c=pendingCandidates.shift();pc.addIceCandidate(c).catch(()=>{})}}
function startRemoteWaitTimer(){clearTimeout(window._rt);window._rt=setTimeout(()=>{try{pc?.restartIce()}catch{}},10000)}

const socket=io();socket.emit('session',sessionId);socket.emit('setTopic',topic);
socket.on('banned',({untilISO})=>{location.href='/banned.html?until='+encodeURIComponent(untilISO||'')});
socket.on('roles',({polite,peerId})=>{isPolite=!!polite;currentPartnerId=peerId});
socket.on('waiting',msg=>{addMessage(msg);setSearching(true)});
socket.on('partnerFound',async()=>{
  setSearching(false); hasPartner=true; chat.textContent=''; addMessage('You found a new partner!');
  if(!localStream){ localStream = await ensureLocal(); }
  if(!pc){ pc=new RTCPeerConnection({...ICE,...(forceRelay?{iceTransportPolicy:'relay'}:{})}); if(localStream)localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
    pc.ontrack=e=>{ if(e.streams&&e.streams[0]){ remoteVideo.srcObject=e.streams[0]; remoteVideo.play().catch(()=>{});} };
    pc.onicecandidate=({candidate})=>{ if(candidate) socket.emit('signal',{type:'ice',candidate}) };
    pc.onconnectionstatechange=()=>{ if(pc.connectionState==='failed'){ try{pc.restartIce()}catch{} } };
    preferBestCodec(pc);
    pc.onnegotiationneeded=async()=>{ try{ makingOffer=true; await pc.setLocalDescription(await pc.createOffer()); socket.emit('signal',{type:'sdp',description:pc.localDescription}); }finally{ makingOffer=false; } };
  }
  const pub=await genECDH().catch(()=>null); if(pub) socket.emit('ecdh-public',pub); startRemoteWaitTimer();
  sendBtn.disabled=false; msgIn.disabled=false;
});
socket.on('signal',async({type,description,candidate})=>{
  if(!pc) return;
  if(type==='sdp'){
    const collision=(description.type==='offer')&&(makingOffer||pc.signalingState!=='stable');
    ignoreOffer=!isPolite&&collision; if(ignoreOffer)return;
    await pc.setRemoteDescription(description);
    if(description.type==='offer'){ await pc.setLocalDescription(await pc.createAnswer()); socket.emit('signal',{type:'sdp',description:pc.localDescription}); }
    drainPending();
  }else if(type==='ice'){
    if(!pc.remoteDescription) pendingCandidates.push(candidate);
    else{ try{ await pc.addIceCandidate(candidate); }catch{} }
  }
});
socket.on('partnerDisconnected',()=>{ hasPartner=false; addMessage('Partner disconnected. Searching…'); setSearching(true); sendBtn.disabled=true; msgIn.disabled=true; setTimeout(()=>{ if(!hasPartner) socket.emit('next'); }, 1800); });
socket.on('forceDisconnect',()=>{ hasPartner=false; addMessage('Partner disconnected. Searching…'); setSearching(true); sendBtn.disabled=true; msgIn.disabled=true; setTimeout(()=>{ if(!hasPartner) socket.emit('next'); }, 1800); });

/* Typing + chat */
const sendBtn=document.getElementById('sendBtn');const msgIn=document.getElementById('messageInput');sendBtn.disabled=true;msgIn.disabled=true;
socket.on('ecdh-public',async(peer)=>{try{await importPeer(peer);}catch{}});
sendBtn.onclick=async()=>{
  const txt=msgIn.value.trim(); if(!txt || !hasPartner) return;
  try{
    if(cryptoKey){ const payload=await encryptText(txt); socket.emit('enc-message',{payload,from:socket.id}); }
    else { socket.emit('message',{text:txt}); }
    addMessage(txt,true); msgIn.value='';
  }catch(_){ socket.emit('message',{text:txt}); addMessage(txt,true); msgIn.value=''; }
};
msgIn.addEventListener('keypress',e=>{if(e.key==='Enter')sendBtn.click();else if(hasPartner)socket.emit('typing',{from:socket.id})});
socket.on('enc-message',({payload,from})=>{ if(from===socket.id) return; decryptText(payload).then(text=>addMessage(text,false)).catch(()=>{}); });
socket.on('message',({text,from})=>{ if(from===socket.id) return; if(typeof text==='string' && text) addMessage(text,false); });
socket.on('partnerTyping',({from})=>{if(!hasPartner||from!==currentPartnerId)return;typing.textContent='Partner is typing...';setTimeout(()=>typing.textContent='',1200)});

/* Reactions */
function spawnReaction(emoji){const host=document.getElementById('videoStage');const el=document.createElement('div');el.className='reaction-fx';el.textContent=emoji;const x=(host.clientWidth/2)+(Math.random()*160-80);const y=host.clientHeight-40;el.style.left=x+'px';el.style.top=y+'px';host.appendChild(el);setTimeout(()=>el.remove(),1400)}
let lastReact=0;document.getElementById('reactionBar').addEventListener('click',e=>{const now=Date.now();if(now-lastReact<600)return;lastReact=now;const btn=e.target.closest('[data-r]');if(!btn||!hasPartner)return;const emoji=btn.getAttribute('data-r');spawnReaction(emoji);socket.emit('reaction',{emoji})});
socket.on('reaction',({emoji})=>spawnReaction(emoji));

/* Block/Report/Streamer */
const BLOCK_KEY='dome_blocked_ids';const getBlocked=()=>new Set(JSON.parse(localStorage.getItem(BLOCK_KEY)||'[]'));const setBlocked=s=>localStorage.setItem(BLOCK_KEY,JSON.stringify([...s]));
document.getElementById('blockBtn').onclick=()=>{if(!currentPartnerId)return alert('No partner to block.');const s=getBlocked();s.add(currentPartnerId);setBlocked(s);alert('Blocked. You won’t be matched again.');socket.emit('disconnectPartner')};
document.getElementById('reportBtn').onclick=()=>{if(!currentPartnerId)return alert('No partner to report.');socket.emit('report',{partnerId:currentPartnerId,topic});const s=getBlocked();s.add(currentPartnerId);setBlocked(s);alert('Reported. You won’t be matched again.');socket.emit('disconnectPartner')};
const streamBtn=document.getElementById('streamBtn');let streamerOn=false,wm;streamBtn.onclick=()=>{streamerOn=!streamerOn;document.body.classList.toggle('streamer',streamerOn);streamBtn.textContent='Streamer: '+(streamerOn?'On':'Off');if(streamerOn&&!wm){wm=document.createElement('div');wm.className='streamer-watermark';wm.textContent='STREAMER MODE — chat hidden';document.body.appendChild(wm)}else if(!streamerOn&&wm){wm.remove();wm=null}};

/* Nav */
document.getElementById('nextBtn').onclick=()=>{if(hasPartner)socket.emit('next');else socket.emit('setTopic',topic)};
document.getElementById('disconnectBtn').onclick=()=>{if(hasPartner)socket.emit('disconnectPartner');hasPartner=false;location.href='/'};
</script></body></html>
